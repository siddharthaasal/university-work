const { Web3 } = require('web3');
const web3 = new Web3('http://127.0.0.1:8545'); //rpc

const contractAddress = "0x5FbDB2315678afecb367f032d93F642f64180aa3";
const contractABI = {
    "_format": "hh-sol-artifact-1",
    "contractName": "ImageVault",
    "sourceName": "contracts/ImageVault.sol",
    "abi": [
        {
            "inputs": [
                {
                    "internalType": "string[]",
                    "name": "_initialUrls",
                    "type": "string[]"
                }
            ],
            "stateMutability": "nonpayable",
            "type": "constructor"
        },
        {
            "anonymous": false,
            "inputs": [
                {
                    "indexed": false,
                    "internalType": "string",
                    "name": "url",
                    "type": "string"
                }
            ],
            "name": "UrlAdded",
            "type": "event"
        },
        {
            "inputs": [
                {
                    "internalType": "string",
                    "name": "_url",
                    "type": "string"
                }
            ],
            "name": "addUrl",
            "outputs": [],
            "stateMutability": "nonpayable",
            "type": "function"
        },
        {
            "inputs": [
                {
                    "internalType": "uint256",
                    "name": "index",
                    "type": "uint256"
                }
            ],
            "name": "getUrl",
            "outputs": [
                {
                    "internalType": "string",
                    "name": "",
                    "type": "string"
                }
            ],
            "stateMutability": "view",
            "type": "function"
        },
        {
            "inputs": [],
            "name": "getUrlCount",
            "outputs": [
                {
                    "internalType": "uint256",
                    "name": "",
                    "type": "uint256"
                }
            ],
            "stateMutability": "view",
            "type": "function"
        },
        {
            "inputs": [
                {
                    "internalType": "uint256",
                    "name": "",
                    "type": "uint256"
                }
            ],
            "name": "urls",
            "outputs": [
                {
                    "internalType": "string",
                    "name": "",
                    "type": "string"
                }
            ],
            "stateMutability": "view",
            "type": "function"
        }
    ],
    "bytecode": "0x608060405234801561001057600080fd5b50604051610fcd380380610fcd833981810160405281019061003291906102fc565b60005b815181101561009a57600082828151811061005357610052610345565b5b602002602001015190806001815401808255809150506001900390600052602060002001600090919091909150908161008c9190610595565b508080600101915050610035565b5050610667565b6000604051905090565b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b610103826100ba565b810181811067ffffffffffffffff82111715610122576101216100cb565b5b80604052505050565b60006101356100a1565b905061014182826100fa565b919050565b600067ffffffffffffffff821115610161576101606100cb565b5b602082029050602081019050919050565b600080fd5b600080fd5b600067ffffffffffffffff821115610197576101966100cb565b5b6101a0826100ba565b9050602081019050919050565b60005b838110156101cb5780820151818401526020810190506101b0565b60008484015250505050565b60006101ea6101e58461017c565b61012b565b90508281526020810184848401111561020657610205610177565b5b6102118482856101ad565b509392505050565b600082601f83011261022e5761022d6100b5565b5b815161023e8482602086016101d7565b91505092915050565b600061025a61025584610146565b61012b565b9050808382526020820190506020840283018581111561027d5761027c610172565b5b835b818110156102c457805167ffffffffffffffff8111156102a2576102a16100b5565b5b8086016102af8982610219565b8552602085019450505060208101905061027f565b5050509392505050565b600082601f8301126102e3576102e26100b5565b5b81516102f3848260208601610247565b91505092915050565b600060208284031215610312576103116100ab565b5b600082015167ffffffffffffffff8111156103305761032f6100b0565b5b61033c848285016102ce565b91505092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806103c657607f821691505b6020821081036103d9576103d861037f565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b6000600883026104417fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82610404565b61044b8683610404565b95508019841693508086168417925050509392505050565b6000819050919050565b6000819050919050565b600061049261048d61048884610463565b61046d565b610463565b9050919050565b6000819050919050565b6104ac83610477565b6104c06104b882610499565b848454610411565b825550505050565b600090565b6104d56104c8565b6104e08184846104a3565b505050565b5b81811015610504576104f96000826104cd565b6001810190506104e6565b5050565b601f8211156105495761051a816103df565b610523846103f4565b81016020851015610532578190505b61054661053e856103f4565b8301826104e5565b50505b505050565b600082821c905092915050565b600061056c6000198460080261054e565b1980831691505092915050565b6000610585838361055b565b9150826002028217905092915050565b61059e82610374565b67ffffffffffffffff8111156105b7576105b66100cb565b5b6105c182546103ae565b6105cc828285610508565b600060209050601f8311600181146105ff57600084156105ed578287015190505b6105f78582610579565b86555061065f565b601f19841661060d866103df565b60005b8281101561063557848901518255600182019150602085019450602081019050610610565b86831015610652578489015161064e601f89168261055b565b8355505b6001600288020188555050505b505050505050565b610957806106766000396000f3fe608060405234801561001057600080fd5b506004361061004c5760003560e01c8063796676be1461005157806385604d8914610081578063ca538e5a146100b1578063eb55787c146100cf575b600080fd5b61006b60048036038101906100669190610355565b6100eb565b6040516100789190610412565b60405180910390f35b61009b60048036038101906100969190610355565b610197565b6040516100a89190610412565b60405180910390f35b6100b961028e565b6040516100c69190610443565b60405180910390f35b6100e960048036038101906100e491906104c3565b61029a565b005b600081815481106100fb57600080fd5b9060005260206000200160009150905080546101169061053f565b80601f01602080910402602001604051908101604052809291908181526020018280546101429061053f565b801561018f5780601f106101645761010080835404028352916020019161018f565b820191906000526020600020905b81548152906001019060200180831161017257829003601f168201915b505050505081565b606060008054905082106101e0576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016101d7906105bc565b60405180910390fd5b600082815481106101f4576101f36105dc565b5b9060005260206000200180546102099061053f565b80601f01602080910402602001604051908101604052809291908181526020018280546102359061053f565b80156102825780601f1061025757610100808354040283529160200191610282565b820191906000526020600020905b81548152906001019060200180831161026557829003601f168201915b50505050509050919050565b60008080549050905090565b60008282909180600181540180825580915050600190039060005260206000200160009091929091929091929091925091826102d79291906107f1565b507f21d5cca3f840791ade736f51501810c14b8b01791ac4357713ed763ccbbaf3a982826040516103099291906108fd565b60405180910390a15050565b600080fd5b600080fd5b6000819050919050565b6103328161031f565b811461033d57600080fd5b50565b60008135905061034f81610329565b92915050565b60006020828403121561036b5761036a610315565b5b600061037984828501610340565b91505092915050565b600081519050919050565b600082825260208201905092915050565b60005b838110156103bc5780820151818401526020810190506103a1565b60008484015250505050565b6000601f19601f8301169050919050565b60006103e482610382565b6103ee818561038d565b93506103fe81856020860161039e565b610407816103c8565b840191505092915050565b6000602082019050818103600083015261042c81846103d9565b905092915050565b61043d8161031f565b82525050565b60006020820190506104586000830184610434565b92915050565b600080fd5b600080fd5b600080fd5b60008083601f8401126104835761048261045e565b5b8235905067ffffffffffffffff8111156104a05761049f610463565b5b6020830191508360018202830111156104bc576104bb610468565b5b9250929050565b600080602083850312156104da576104d9610315565b5b600083013567ffffffffffffffff8111156104f8576104f761031a565b5b6105048582860161046d565b92509250509250929050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b6000600282049050600182168061055757607f821691505b60208210810361056a57610569610510565b5b50919050565b7f496e646578206f7574206f6620626f756e647300000000000000000000000000600082015250565b60006105a660138361038d565b91506105b182610570565b602082019050919050565b600060208201905081810360008301526105d581610599565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b600082905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b6000600883026106a77fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8261066a565b6106b1868361066a565b95508019841693508086168417925050509392505050565b6000819050919050565b60006106ee6106e96106e48461031f565b6106c9565b61031f565b9050919050565b6000819050919050565b610708836106d3565b61071c610714826106f5565b848454610677565b825550505050565b600090565b610731610724565b61073c8184846106ff565b505050565b5b8181101561076057610755600082610729565b600181019050610742565b5050565b601f8211156107a55761077681610645565b61077f8461065a565b8101602085101561078e578190505b6107a261079a8561065a565b830182610741565b50505b505050565b600082821c905092915050565b60006107c8600019846008026107aa565b1980831691505092915050565b60006107e183836107b7565b9150826002028217905092915050565b6107fb838361060b565b67ffffffffffffffff81111561081457610813610616565b5b61081e825461053f565b610829828285610764565b6000601f8311600181146108585760008415610846578287013590505b61085085826107d5565b8655506108b8565b601f19841661086686610645565b60005b8281101561088e57848901358255600182019150602085019450602081019050610869565b868310156108ab57848901356108a7601f8916826107b7565b8355505b6001600288020188555050505b50505050505050565b82818337600083830152505050565b60006108dc838561038d565b93506108e98385846108c1565b6108f2836103c8565b840190509392505050565b600060208201905081810360008301526109188184866108d0565b9050939250505056fea2646970667358221220aa4ac5ec3f453505a369582728a25e46f8fb9c647ff6dc184506dadfdc9ca19064736f6c634300081c0033",
    "deployedBytecode": "0x608060405234801561001057600080fd5b506004361061004c5760003560e01c8063796676be1461005157806385604d8914610081578063ca538e5a146100b1578063eb55787c146100cf575b600080fd5b61006b60048036038101906100669190610355565b6100eb565b6040516100789190610412565b60405180910390f35b61009b60048036038101906100969190610355565b610197565b6040516100a89190610412565b60405180910390f35b6100b961028e565b6040516100c69190610443565b60405180910390f35b6100e960048036038101906100e491906104c3565b61029a565b005b600081815481106100fb57600080fd5b9060005260206000200160009150905080546101169061053f565b80601f01602080910402602001604051908101604052809291908181526020018280546101429061053f565b801561018f5780601f106101645761010080835404028352916020019161018f565b820191906000526020600020905b81548152906001019060200180831161017257829003601f168201915b505050505081565b606060008054905082106101e0576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016101d7906105bc565b60405180910390fd5b600082815481106101f4576101f36105dc565b5b9060005260206000200180546102099061053f565b80601f01602080910402602001604051908101604052809291908181526020018280546102359061053f565b80156102825780601f1061025757610100808354040283529160200191610282565b820191906000526020600020905b81548152906001019060200180831161026557829003601f168201915b50505050509050919050565b60008080549050905090565b60008282909180600181540180825580915050600190039060005260206000200160009091929091929091929091925091826102d79291906107f1565b507f21d5cca3f840791ade736f51501810c14b8b01791ac4357713ed763ccbbaf3a982826040516103099291906108fd565b60405180910390a15050565b600080fd5b600080fd5b6000819050919050565b6103328161031f565b811461033d57600080fd5b50565b60008135905061034f81610329565b92915050565b60006020828403121561036b5761036a610315565b5b600061037984828501610340565b91505092915050565b600081519050919050565b600082825260208201905092915050565b60005b838110156103bc5780820151818401526020810190506103a1565b60008484015250505050565b6000601f19601f8301169050919050565b60006103e482610382565b6103ee818561038d565b93506103fe81856020860161039e565b610407816103c8565b840191505092915050565b6000602082019050818103600083015261042c81846103d9565b905092915050565b61043d8161031f565b82525050565b60006020820190506104586000830184610434565b92915050565b600080fd5b600080fd5b600080fd5b60008083601f8401126104835761048261045e565b5b8235905067ffffffffffffffff8111156104a05761049f610463565b5b6020830191508360018202830111156104bc576104bb610468565b5b9250929050565b600080602083850312156104da576104d9610315565b5b600083013567ffffffffffffffff8111156104f8576104f761031a565b5b6105048582860161046d565b92509250509250929050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b6000600282049050600182168061055757607f821691505b60208210810361056a57610569610510565b5b50919050565b7f496e646578206f7574206f6620626f756e647300000000000000000000000000600082015250565b60006105a660138361038d565b91506105b182610570565b602082019050919050565b600060208201905081810360008301526105d581610599565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b600082905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b6000600883026106a77fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8261066a565b6106b1868361066a565b95508019841693508086168417925050509392505050565b6000819050919050565b60006106ee6106e96106e48461031f565b6106c9565b61031f565b9050919050565b6000819050919050565b610708836106d3565b61071c610714826106f5565b848454610677565b825550505050565b600090565b610731610724565b61073c8184846106ff565b505050565b5b8181101561076057610755600082610729565b600181019050610742565b5050565b601f8211156107a55761077681610645565b61077f8461065a565b8101602085101561078e578190505b6107a261079a8561065a565b830182610741565b50505b505050565b600082821c905092915050565b60006107c8600019846008026107aa565b1980831691505092915050565b60006107e183836107b7565b9150826002028217905092915050565b6107fb838361060b565b67ffffffffffffffff81111561081457610813610616565b5b61081e825461053f565b610829828285610764565b6000601f8311600181146108585760008415610846578287013590505b61085085826107d5565b8655506108b8565b601f19841661086686610645565b60005b8281101561088e57848901358255600182019150602085019450602081019050610869565b868310156108ab57848901356108a7601f8916826107b7565b8355505b6001600288020188555050505b50505050505050565b82818337600083830152505050565b60006108dc838561038d565b93506108e98385846108c1565b6108f2836103c8565b840190509392505050565b600060208201905081810360008301526109188184866108d0565b9050939250505056fea2646970667358221220aa4ac5ec3f453505a369582728a25e46f8fb9c647ff6dc184506dadfdc9ca19064736f6c634300081c0033",
    "linkReferences": {},
    "deployedLinkReferences": {}
}


let imageVault;

async function init() {
    // Connect to the local Ethereum node
    if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        await window.ethereum.request({ method: "eth_requestAccounts" });
        imageVault = new web3.eth.Contract(contractABI, contractAddress);
        loadUrls();
    } else {
        alert("Please install MetaMask!");
    }
}

async function loadUrls() {
    const count = await imageVault.methods.getUrlCount().call();
    const urlList = document.getElementById("urlList");
    urlList.innerHTML = "";

    for (let i = 0; i < count; i++) {
        const url = await imageVault.methods.getUrl(i).call();
        const listItem = document.createElement("li");
        listItem.textContent = url;
        urlList.appendChild(listItem);
    }
}

document.getElementById("addUrlButton").addEventListener("click", async () => {
    const urlInput = document.getElementById("urlInput");
    const url = urlInput.value;

    const accounts = await web3.eth.getAccounts();
    await imageVault.methods.addUrl(url).send({ from: accounts[0] });

    urlInput.value = "";
    loadUrls();
});

// Initialize the app
window.addEventListener("load", init);
